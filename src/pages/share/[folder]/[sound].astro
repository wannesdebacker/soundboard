---
import Layout from "../../../layouts/Layout.astro";

export async function getStaticPaths() {
  const { getSoundFiles } = await import("../../../lib/");
  const sounds = getSoundFiles();

  const paths = [];
  for (const folder in sounds) {
    for (const sound of sounds[folder]) {
      const fileName = sound.location.split("/").pop();
      paths.push({
        params: { folder, sound: fileName },
        props: { soundName: sound.name, soundLocation: sound.location, folder },
      });
    }
  }

  return paths;
}

const { folder, sound } = Astro.params;
const { soundName, soundLocation } = Astro.props;

const baseUrl = Astro.site || Astro.url.origin;
const base = import.meta.env.BASE_URL || "/";
const normalizedBase = base.endsWith("/") ? base.slice(0, -1) : base;
const shareUrl = `${baseUrl}${normalizedBase}/share/${folder}/${sound}`;
const imageUrl = `${baseUrl}${normalizedBase}/api/og/${folder}/${sound}`;
const audioUrl = `${baseUrl}${normalizedBase}/${soundLocation.replace(/^\//, "")}`;
---

<Layout title={`${soundName} - Soundboard`}>
  <Fragment slot="head">
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="music.song" />
    <meta property="og:url" content={shareUrl} />
    <meta property="og:title" content={soundName} />
    <meta
      property="og:description"
      content={`Listen to "${soundName}" from the soundboard`}
    />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:audio" content={audioUrl} />
    <meta property="og:audio:type" content="audio/mpeg" />

    <!-- Twitter -->
    <meta property="twitter:card" content="player" />
    <meta property="twitter:url" content={shareUrl} />
    <meta property="twitter:title" content={soundName} />
    <meta
      property="twitter:description"
      content={`Listen to "${soundName}" from the soundboard`}
    />
    <meta property="twitter:image" content={imageUrl} />
    <meta property="twitter:player" content={shareUrl} />
    <meta property="twitter:player:width" content="480" />
    <meta property="twitter:player:height" content="200" />
  </Fragment>

  <div class="share-container">
    <h2>{soundName}</h2>
    <div class="audio-controls">
      <audio controls preload="auto">
        <source
          src={`${normalizedBase}/${soundLocation.replace(/^\//, "")}`}
          type="audio/mpeg"
        />
        Your browser does not support the audio element.
      </audio>
    </div>
  </div>
</Layout>

<style>
  .share-container {
    text-align: center;
    max-width: 600px;
    margin: 2rem auto;
  }

  .audio-controls {
    margin: 2rem 0;
  }

  .audio-controls audio {
    width: 100%;
    max-width: 500px;
  }

  a {
    display: inline-block;
    margin-top: 2rem;
  }
</style>
